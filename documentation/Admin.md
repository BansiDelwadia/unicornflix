## Web Client Admin View  

This workshop provides a react application that will serve as the basis for your development and is split into two views. The Admin view provides UnicornFlix employees video management capabilities and the User view is where subscribers access content after they've logged into the site.

1. To install the dependencies necessary to run the website locally run `npm install` from the UnicornFlix directory. Notable packages include:
    - `aws-amplify` - A javascript library that provides a declarative interface across amplify catagories, like auth, in order to make them easier to add them into your application
    - `aws-amplify-react` - A UI component library for React to use with the CLI resources
1. Next, to run the website with a local development environment run `npm start` and navigate to the page running on localhost.

Let's start with adding connections to all of our AWS resources, so that we can start communiticating back and forth with our API and Auth components we added earlier.

1. In an IDE open `unicornflix/src/index.js`
1. Insert at the top of the file an import to bring in all the required resources for the API and Auth that we created. Inside the `aws-exports` file contains all the API and Auth definitions that are required for this workshop.
    ```javascript
    import awsconfig from './aws-exports';
    import Amplify from 'aws-amplify';

    Amplify.configure(awsconfig);
    ```

Now that our AWS resources have been configured, lets add the Admin functionality as this will allow us to create new content. To do so, we will first drop in the authenticator component and configure it to wrap the Admin react component that renders the Admin page.

1. In an IDE open `unicornflix/src/components/Admin/index.jsx`
1. At the bottom of the import block, add the following statement to bring in the Authenticator component:

    ```javascript
    import { withAuthenticator } from 'aws-amplify-react'; 
    ```
1. Replace `export default Admin;` to the following statement which wraps the Admin page with the newly imported Authenticator component:
    ```javascript
    export default withAuthenticator(Admin, true);
    ```
1. Now when you visit `localhost:3000/Admin` or whatever url + `/Admin` you will now see a new login page.

Now we need an Admin user to test out the authentication functionality, let's create an admin user through the Cognito console. 

1. Open the AWS Management Console and Search for Cognito.
1. Select the blue "Manage User Pools" button
1. Select the userpool labeled "Unicornflix"
1. Under General Settings, choose "Users and Groups"
1. Select the blue "create user" button and enter the user creation form.
1. Fill out the form to create a user. Now we will have to add admin privilages in order to enable this user to publish videos through the app.
1. Select the user you just created
1. Select the blue "Add to Group" button, and select the admin group.

Now that we have an admin user, let's implement the asset upload logic that enables them to create new assets on the platform.

1. In and IDE, Open `unicornflix/src/Components/Admin/index.jsx`
1. First we will need to import some important files and libraries to assist us with connecting the backend to our React app. The first import adds in some library componets provided by Amplify's libraries to get Authentication information, perform API requests, generate GraphQL operations and interact with the Storage added in Amplify Video. The second file is generated by the Amplify Video CLI command you ran earlier. This file contains both the input and output bucket for your Video On Demand Assests. The last file, GraphQL mutations contains the two mutations we will be preforming to create new Assets.
  ```javascript
  import {
    Auth, API, graphqlOperation, Storage,
  } from 'aws-amplify';
  import awsvideoconfig from '../../aws-video-exports';
  import { createVodAsset, createVideoObject } from '../../graphql/mutations';
  ```
1. Now that our backend is configured with our frontend we will now need to provide some context to the Storage component and get the current users status from the Auth moduel. In the `componentDidMount` function paste the following code into the function body. You must provide the unicornflix workshop region into the object below.
    ```javascript
    Auth.currentSession()
      .then((data) => {
        const groups = data.idToken.payload['cognito:groups'];
        if (groups) {
          this.setState({ groups: data.idToken.payload['cognito:groups'] });
        }
      });

    Storage.configure({
      AWSS3: {
        bucket: awsvideoconfig.awsOutputVideo,
        region: '<REGION>',
      },
    });
    ```
    <details>
        <summary>Click here to see an example of a correct region</summary>

    ```javascript
    Storage.configure({
        AWSS3: {
            bucket: awsvideoconfig.awsOutputVideo,
            region: 'us-west-2'
        }
    })
    ```
    </details>
1. Find the submitFormHandler(event) function and add the following code to the function body. This is the form that contains basic metadata to be submitted alongside the asset upload. The API calls first create the asset tracker in the DynamoDB table. After the asset tracker is create then we will fire off the operation to create the VideoObject and the Storage operation to upload all the metadata and the video file.

    ```javascript
    const uuid = uuidv4();

    const videoObject = {
      input: {
        id: uuid,
        objectID: uuid,
      },
    };

    API.graphql(graphqlOperation(createVideoObject, videoObject)).then((response, error) => {
      if (error !== undefined) {
        const { titleVal, descVal, file } = this.state;
        const videoAsset = {
          input: {
            title: titleVal,
            description: descVal,
            vodAssetVideoId: uuid,
          },
        };
        API.graphql(graphqlOperation(createVodAsset, videoAsset));
        Storage.put(`${uuid}.mp4`, file, {
          contentType: 'video/*',
        })
          .then(() => console.log(`Successfully Uploaded: ${uuid}`))
          .catch((err) => console.log(`Error: ${err}`));
      }
    });
    ```

Let's put our implementation of the admin page to the test by uploading an asset.

1. Navigate back to the application running on your Localhost.
1. Log in to the admin user you created. Note: if you were previously logged in before creating your admin user, log out and log back in to refresh your tokens giving you access to post content.
1. Navigate to the Admin Panel by going to the `/Admin` page in the browser
1. Fill out the form and select a video with the file picker or use the sample video located in `/images/sample.mp4` 
1. Once all the fields have been selected, choose the "submit" button to begin the upload process.

Since we haven't implemented the user view yet, let's use the AWS console to explore what happened when we created the asset.

1. Open the aws management console and navigate to the DynamoDB service using the search bar.
1. In the left hand side bar, choose "Tables"
1. You should see two DynamoDB Tables that were deployed on your behalf by Amplify Video: Vodasset- (the video metadata) and VideoObject- (the video access URLs)
1. Select the VodAsset- table and choose "Items" to view the asset you just pushed to the cloud using the Application. Here you can see that the API gave each asset a GUID as well as createdAt/updatedAt fields.
1. In the management console, select the services drop down from the top left corner of the browser screen.
1. In the search bar type MediaConvert and navigate to the Elemental MediaConvert service page.
1. Expand the left hand side menu and choose "Jobs"
1. You should see a job that was kicked off when you uploaded an asset through the console. You can view the input file name to be sure that the upload from the application was successful.
1. (Optional) Select the job and select the "View JSON" button in the top right of the screen. Here you can view the job file which was submitted to the Elemental MediaConvert Service. Here, you can view the input and output locations as well as presets used during the transcode process.

Now that we have a functioning backend with an admin portal, [let's set up the end user view!](./UserView.md).
